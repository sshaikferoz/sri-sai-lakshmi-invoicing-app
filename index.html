<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Management System</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Professional Color Palette */
        :root {
            --primary-blue: #1E88E5;
            --primary-blue-dark: #1976D2;
            --secondary-green: #43A047;
            --accent-amber: #FFC107;
            --neutral-white: #FFFFFF;
            --neutral-light: #F5F5F5;
            --neutral-gray: #E0E0E0;
            --text-dark: #212121;
            --text-medium: #757575;
            --text-light: #9E9E9E;
        }

        .invoice-preview {
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.4;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            .printable-invoice * {
                visibility: visible;
            }

            .printable-invoice {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }

        /* Modern UI Styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(224, 224, 224, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .input-modern {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 1.5px solid var(--neutral-gray);
            border-radius: 12px;
            background: var(--neutral-white);
            transition: all 0.3s ease;
            color: var(--text-dark);
            font-weight: 400;
        }

        .input-modern:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.1);
            background: var(--neutral-white);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-blue-dark));
            color: var(--neutral-white);
            border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(30, 136, 229, 0.2);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 136, 229, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--neutral-white);
            color: var(--text-dark);
            border: 1.5px solid var(--neutral-gray);
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            border-color: var(--primary-blue);
            background: rgba(30, 136, 229, 0.05);
        }

        .btn-draft {
            background: linear-gradient(135deg, var(--accent-amber), #F57F17);
            color: var(--neutral-white);
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }

        .btn-draft:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }

        .btn-draft:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .section-card {
            background: var(--neutral-white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(224, 224, 224, 0.5);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
        }

        .sidebar {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            background: var(--neutral-white);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.08);
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .invoice-item {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .invoice-item:hover {
            background: rgba(30, 136, 229, 0.05);
            border-color: rgba(30, 136, 229, 0.2);
        }

        .invoice-item.active {
            background: rgba(30, 136, 229, 0.1);
            border-color: var(--primary-blue);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-draft {
            background: rgba(255, 193, 7, 0.1);
            color: #F57F17;
        }

        .status-sent {
            background: rgba(30, 136, 229, 0.1);
            color: var(--primary-blue);
        }

        .status-paid {
            background: rgba(67, 160, 71, 0.1);
            color: var(--secondary-green);
        }

        .overlay {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(2px);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }

        .filter-section {
            border-bottom: 1px solid rgba(224, 224, 224, 0.5);
            margin-bottom: 16px;
            padding-bottom: 16px;
        }

        .filter-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .unsaved-indicator {
            width: 8px;
            height: 8px;
            background: var(--accent-amber);
            border-radius: 50%;
            display: inline-block;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const InvoiceManagementSystem = () => {
            const [mode, setMode] = useState('form'); // 'form' or 'pdf'
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [invoices, setInvoices] = useState([]);
            const [filteredInvoices, setFilteredInvoices] = useState([]);
            const [selectedInvoice, setSelectedInvoice] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [statusFilter, setStatusFilter] = useState('all');
            const [dateFilter, setDateFilter] = useState({ from: '', to: '' });
            const [amountFilter, setAmountFilter] = useState({ min: '', max: '' });
            const [customerFilter, setCustomerFilter] = useState('');
            const [loading, setLoading] = useState(false);
            const [saving, setSaving] = useState(false);
            const [pdfGenerating, setPdfGenerating] = useState(false);
            const [showConfirmDialog, setShowConfirmDialog] = useState(false);
            const [pendingAction, setPendingAction] = useState(null);
            const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
            const [isSaved, setIsSaved] = useState(false);

            const [formData, setFormData] = useState({
                _id: null,
                invoiceNumber: '',
                date: new Date().toISOString().split('T')[0].split('-').reverse().join('-'),
                vehicleNumber: '',
                companyDetails: {
                    companyName: 'SRI SAI LAKSHMI ENTERPRISES',
                    address: '4-77, Elikatta Village, Farooqnagar Mandal,Ranga Reddy Dist, Telangana, 509216',
                    mobile: '8309590863',
                    email: 'sslenterprises1988@gmail.com',
                    gstn: '36CJTPP4170J1ZJ',
                    placeOfService: 'Ellikatta (V), Farooqnagar (M), R R Dist,Telangana-509216',
                    stateCode: '36'
                },
                customerDetails: {
                    receiverName: 'SHAJI MINERALS',
                    receiverAddress: '43-58A, Flat No. 201',
                    receiverCity: 'N.R Peta, Kurnool- 518004',
                    receiverState: 'A.P',
                    customerGST: '37GWQPS8985E1ZB'
                },
                shippingDetails: {
                    shipToName: 'JAI RAJ ISPAT LIMITED',
                    shipToAddress: 'Orvakal Mega Industrial Hub',
                    shipToCity: 'Guttapadu Village',
                    shipToState: 'Orvakal Mandal, Kurnool',
                    shipToGST: '37AAACJ6859P3ZO'
                },
                bankDetails: {
                    bankName: 'SRI SAI LAKSHMI ENTERPRISES',
                    accountNo: '50200054088341',
                    bankBranch: 'HDFC Bank , Branch Name: Shadnagar',
                    ifscCode: 'HDFC0004330'
                },
                items: [],
                status: 'draft'
            });

            // Mock data - replace with actual API calls
            const mockInvoices = [
                {
                    "_id": "68d4e3f9167a4b9812c3c043",
                    "invoiceNumber": "SSLE-07",
                    "date": "25-09-2025",
                    "vehicleNumber": "TG09AB1234",
                    "customerDetails": {
                        "receiverName": "SHAJI MINERALS",
                        "receiverCity": "N.R Peta, Kurnool- 518004"
                    },
                    "taxCalculation": {
                        "totalAfterTax": 50745.9
                    },
                    "status": "draft",
                    "createdAt": "2025-09-25T06:40:57.397Z"
                },
                {
                    "_id": "68d4e1f3d2a63124029f03c9",
                    "invoiceNumber": "SSLE-011",
                    "date": "24-09-2025",
                    "vehicleNumber": "TG09AB1234",
                    "customerDetails": {
                        "receiverName": "TECH SOLUTIONS PVT LTD",
                        "receiverCity": "Bangalore- 560001"
                    },
                    "taxCalculation": {
                        "totalAfterTax": 25000.0
                    },
                    "status": "sent",
                    "createdAt": "2025-09-24T06:32:19.124Z"
                }
            ];

            useEffect(() => {
                loadInvoices();
            }, []);

            useEffect(() => {
                // Filter invoices based on all filters
                let filtered = invoices.filter(invoice => {
                    const matchesSearch = searchQuery === '' ||
                        (invoice.invoiceNumber || invoice.invoiceNo || '').toLowerCase().includes(searchQuery.toLowerCase()) ||
                        (invoice.customerDetails?.receiverName || '').toLowerCase().includes(searchQuery.toLowerCase());

                    const matchesStatus = statusFilter === 'all' || invoice.status === statusFilter;

                    const matchesCustomer = customerFilter === '' ||
                        (invoice.customerDetails?.receiverName || '').toLowerCase().includes(customerFilter.toLowerCase());

                    // Date filter
                    const matchesDate = (!dateFilter.from && !dateFilter.to) || (() => {
                        const invoiceDate = new Date(invoice.createdAt);
                        const fromDate = dateFilter.from ? new Date(dateFilter.from) : null;
                        const toDate = dateFilter.to ? new Date(dateFilter.to) : null;

                        if (fromDate && toDate) {
                            return invoiceDate >= fromDate && invoiceDate <= toDate;
                        } else if (fromDate) {
                            return invoiceDate >= fromDate;
                        } else if (toDate) {
                            return invoiceDate <= toDate;
                        }
                        return true;
                    })();

                    // Amount filter
                    const matchesAmount = (!amountFilter.min && !amountFilter.max) || (() => {
                        const amount = invoice.taxCalculation?.totalAfterTax || 0;
                        const minAmount = amountFilter.min ? parseFloat(amountFilter.min) : 0;
                        const maxAmount = amountFilter.max ? parseFloat(amountFilter.max) : Infinity;
                        return amount >= minAmount && amount <= maxAmount;
                    })();

                    return matchesSearch && matchesStatus && matchesCustomer && matchesDate && matchesAmount;
                });

                setFilteredInvoices(filtered);
            }, [invoices, searchQuery, statusFilter, dateFilter, amountFilter, customerFilter]);

            useEffect(() => {
                const urlParams = new URLSearchParams(window.location.search);
                const invoiceData = urlParams.get('data');

                if (invoiceData) {
                    try {
                        const decodedData = JSON.parse(decodeURIComponent(invoiceData));
                        setFormData(decodedData);
                        setMode('pdf');
                    } catch (error) {
                        console.error('Error parsing URL parameters:', error);
                    }
                }
            }, []);

            // Track unsaved changes
            useEffect(() => {
                if (selectedInvoice) {
                    setHasUnsavedChanges(false);
                } else if (formData.invoiceNumber || formData.items.length > 0) {
                    setHasUnsavedChanges(!isSaved);
                }
            }, [formData, selectedInvoice, isSaved]);

            const loadInvoices = async () => {
                setLoading(true);
                try {
                    // Replace with actual API call
                    const response = await fetch('http://localhost:8080/api/pdf/invoices');
                    const data = await response.json();
                    setInvoices(data);
                    setFilteredInvoices(data);
                } catch (error) {
                    console.error('Error loading invoices:', error);
                    // Fallback to mock data for demo
                    setInvoices(mockInvoices);
                    setFilteredInvoices(mockInvoices);
                }
                setLoading(false);
            };

            const saveAsDraft = async () => {
                if (!formData.invoiceNumber.trim()) {
                    alert('Please enter an invoice number before saving');
                    return;
                }

                setSaving(true);
                try {
                    const calculations = calculateAmounts();
                    const invoiceData = {
                        ...formData,
                        ...calculations,
                        status: 'draft',
                        updatedAt: new Date().toISOString()
                    };

                    // Remove _id if creating new invoice
                    if (!formData._id) {
                        delete invoiceData._id;
                    }


                    console.log('Saving Invoice Data:', invoiceData);

                    const response = await fetch('http://localhost:8080/api/pdf/invoices', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(invoiceData)
                    });

                    if (!response.ok) {
                        throw new Error(`Failed to save: ${response.status} ${response.statusText}`);
                    }

                    const savedInvoice = await response.json();

                    // Update form data with saved invoice ID
                    setFormData(prev => ({ ...prev, _id: savedInvoice._id || savedInvoice.id }));
                    setSelectedInvoice(savedInvoice);
                    setIsSaved(true);
                    setHasUnsavedChanges(false);

                    // Reload invoices list
                    await loadInvoices();

                    alert('Invoice saved as draft successfully!');
                } catch (error) {
                    console.error('Error saving invoice:', error);
                    alert(`Failed to save invoice: ${error.message}`);
                } finally {
                    setSaving(false);
                }
            };

            const selectInvoice = (invoice) => {
                if (hasUnsavedChanges) {
                    setPendingAction(() => () => {
                        performSelectInvoice(invoice);
                    });
                    setShowConfirmDialog(true);
                    return;
                }
                performSelectInvoice(invoice);
            };

            const performSelectInvoice = (invoice) => {
                setSelectedInvoice(invoice);
                console.log('Selected Invoice:', invoice);
                setFormData({
                    _id: invoice._id,
                    invoiceNumber: invoice.invoiceNumber || invoice.invoiceNo || '',
                    date: invoice.date || '',
                    vehicleNumber: invoice.vehicleNumber || '',
                    companyDetails: invoice.companyDetails || formData.companyDetails,
                    customerDetails: invoice.customerDetails || formData.customerDetails,
                    shippingDetails: invoice.shippingDetails || formData.shippingDetails,
                    bankDetails: invoice.bankDetails || formData.bankDetails,
                    items: invoice.items || [],
                    status: invoice.status || 'draft'
                });
                setIsSaved(true);
                setHasUnsavedChanges(false);
                setSidebarOpen(false);
            };

            const createNewInvoice = () => {
                if (hasUnsavedChanges) {
                    setPendingAction(() => () => {
                        performCreateNewInvoice();
                    });
                    setShowConfirmDialog(true);
                    return;
                }
                performCreateNewInvoice();
            };

            const performCreateNewInvoice = () => {
                setSelectedInvoice(null);
                setFormData({
                    ...formData,
                    _id: null,
                    invoiceNumber: '',
                    items: [],
                    status: 'draft'
                });
                setIsSaved(false);
                setHasUnsavedChanges(false);
                setSidebarOpen(false);
            };

            const handleConfirmDialog = (confirm) => {
                if (confirm && pendingAction) {
                    pendingAction();
                }
                setShowConfirmDialog(false);
                setPendingAction(null);
            };

            const clearAllFilters = () => {
                setSearchQuery('');
                setStatusFilter('all');
                setDateFilter({ from: '', to: '' });
                setAmountFilter({ min: '', max: '' });
                setCustomerFilter('');
            };

            // Calculate amounts automatically
            const calculateAmounts = () => {
                let totalBeforeTax = 0;
                const calculatedItems = formData.items.map(item => {
                    const qty = parseFloat(item.qty) || 0;
                    const rate = parseFloat(item.rate) || 0;
                    const amount = qty * rate;
                    totalBeforeTax += amount;
                    return {
                        ...item,
                        amount: amount === 0 ? '0.00' : amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                    };
                });

                const igst = totalBeforeTax * 0.18;
                const totalAfterTax = totalBeforeTax + igst;

                return {
                    items: calculatedItems,
                    totalBeforeTax: totalBeforeTax.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
                    igst: igst.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
                    totalAfterTax: totalAfterTax.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
                    netAmount: totalAfterTax.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }),
                    amountInWords: numberToWords(Math.round(totalAfterTax)),
                    taxCalculation: { totalAfterTax: totalAfterTax }
                };
            };

            // Convert number to words
            const numberToWords = (num) => {
                const ones = ['', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN', 'EIGHT', 'NINE'];
                const tens = ['', '', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY', 'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY'];
                const teens = ['TEN', 'ELEVEN', 'TWELVE', 'THIRTEEN', 'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN'];

                if (num === 0) return 'ZERO RUPEES ONLY';

                let result = '';

                if (num >= 10000000) {
                    const crores = Math.floor(num / 10000000);
                    result += convertHundreds(crores) + ' CRORE ';
                    num %= 10000000;
                }

                if (num >= 100000) {
                    const lakhs = Math.floor(num / 100000);
                    result += convertHundreds(lakhs) + ' LAKH ';
                    num %= 100000;
                }

                if (num >= 1000) {
                    const thousands = Math.floor(num / 1000);
                    result += convertHundreds(thousands) + ' THOUSAND ';
                    num %= 1000;
                }

                if (num >= 100) {
                    const hundreds = Math.floor(num / 100);
                    result += ones[hundreds] + ' HUNDRED ';
                    num %= 100;
                }

                if (num >= 20) {
                    const tensDigit = Math.floor(num / 10);
                    result += tens[tensDigit] + ' ';
                    num %= 10;
                }

                if (num >= 10 && num < 20) {
                    result += teens[num - 10] + ' ';
                } else if (num > 0) {
                    result += ones[num] + ' ';
                }

                function convertHundreds(n) {
                    let str = '';
                    if (n >= 100) {
                        str += ones[Math.floor(n / 100)] + ' HUNDRED ';
                        n %= 100;
                    }
                    if (n >= 20) {
                        str += tens[Math.floor(n / 10)] + ' ';
                        n %= 10;
                    }
                    if (n >= 10 && n < 20) {
                        str += teens[n - 10] + ' ';
                    } else if (n > 0) {
                        str += ones[n] + ' ';
                    }
                    return str.trim();
                }

                return result.trim() + ' RUPEES ONLY';
            };

            const handleInputChange = (e, section = null, index = null, field = null) => {
                if (index !== null && field && section === 'items') {
                    const newItems = [...formData.items];
                    newItems[index][field] = e.target.value;
                    setFormData({ ...formData, items: newItems });
                } else if (section) {
                    setFormData({
                        ...formData,
                        [section]: {
                            ...formData[section],
                            [e.target.name]: e.target.value
                        }
                    });
                } else {
                    setFormData({ ...formData, [e.target.name]: e.target.value });
                }

                // Mark as having unsaved changes if not already saved
                if (!isSaved) {
                    setHasUnsavedChanges(true);
                }
            };

            const addItem = () => {
                setFormData({
                    ...formData,
                    items: [...formData.items, { description: '', sacCode: '998622', qty: '', rate: '' }]
                });
                if (!isSaved) {
                    setHasUnsavedChanges(true);
                }
            };

            const removeItem = (index) => {
                const newItems = formData.items.filter((_, i) => i !== index);
                setFormData({ ...formData, items: newItems });
                if (!isSaved) {
                    setHasUnsavedChanges(true);
                }
            };

            const generatePDF = async () => {

                // Check if invoice is saved in database
                if (!formData._id || !isSaved) {
                    alert('Please save the invoice as draft first before downloading PDF');
                    return;
                }

                setPdfGenerating(true);
                try {
                    const calculations = calculateAmounts();
                    const updatedFormData = { ...formData, ...calculations };

                    const encodedData = encodeURIComponent(JSON.stringify(updatedFormData));
                    const invoiceUrl = `https://sri-sai-lakshmi-invoicing-app.vercel.app/?data=${encodedData}`;

                    const response = await fetch('https://gotenberg-269327981098.europe-west1.run.app/api/pdf/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            url: invoiceUrl
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }

                    const pdfBlob = await response.blob();
                    const downloadUrl = window.URL.createObjectURL(pdfBlob);
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = `tax-invoice-${formData.invoiceNumber || 'new'}.pdf`;

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(downloadUrl);

                } catch (error) {
                    console.error('PDF Generation Error:', error);
                    alert(`Failed to generate PDF: ${error.message}`);

                    const calculations = calculateAmounts();
                    const updatedFormData = { ...formData, ...calculations };
                    const encodedData = encodeURIComponent(JSON.stringify(updatedFormData));
                    const currentUrl = window.location.href.split('?')[0];
                    const newUrl = `${currentUrl}?data=${encodedData}`;
                    window.open(newUrl, '_blank');
                } finally {
                    setPdfGenerating(false);
                }
            };

            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                return new Date(dateStr).toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('en-IN', {
                    style: 'currency',
                    currency: 'INR',
                    minimumFractionDigits: 0
                }).format(amount);
            };

            const calculations = calculateAmounts();

            if (mode === 'pdf') {
                return (
                    <div className="min-h-screen bg-gray-50 py-8">
                        <div className="max-w-4xl mx-auto px-4">
                            <div className="bg-white rounded-lg shadow-lg p-6">
                                <div className="printable-invoice bg-white border border-gray-300 p-6">
                                    <div className="invoice-preview text-xs">
                                        {/* Header */}
                                        <div className="text-center p-2 mb-1">
                                            <div className="font-bold text-lg">TAX INVOICE</div>
                                        </div>

                                        <div className="text-center border border-black p-2 mb-1">
                                            <div className="font-bold text-base">{formData.companyDetails.companyName}</div>
                                        </div>

                                        {/* Company Details */}
                                        <div className="mb-2 text-xs">
                                            <div>Address : {formData.companyDetails.address}</div>
                                            <div>Mobile No: {formData.companyDetails.mobile} ; e-mail: {formData.companyDetails.email}</div>
                                            <div>Our GSTN : {formData.companyDetails.gstn}</div>
                                            <div>Place of Service : {formData.companyDetails.placeOfService}</div>
                                            <div>State Code : {formData.companyDetails.stateCode}</div>
                                        </div>

                                        {/* Invoice and Customer Details */}
                                        <div className="grid grid-cols-12 border border-black text-xs">
                                            <div className="col-span-4 border-r border-black p-2">
                                                <div className="font-bold">Details of Receiver (Billed to)</div>
                                                <div className="mt-2">
                                                    <div>{formData.customerDetails.receiverName}</div>
                                                    <div>{formData.customerDetails.receiverAddress}</div>
                                                    <div>{formData.customerDetails.receiverCity}</div>
                                                    <div>{formData.customerDetails.receiverState}</div>
                                                    <div>GST: {formData.customerDetails.customerGST}</div>
                                                </div>
                                            </div>
                                            <div className="col-span-4 border-r border-black p-2">
                                                <div className="font-bold">Ship to Details</div>
                                                <div className="mt-2">
                                                    <div>{formData.shippingDetails.shipToName}</div>
                                                    <div>{formData.shippingDetails.shipToAddress}</div>
                                                    <div>{formData.shippingDetails.shipToCity}</div>
                                                    <div>{formData.shippingDetails.shipToState}</div>
                                                    <div>GST: {formData.shippingDetails.shipToGST}</div>
                                                </div>
                                            </div>
                                            <div className="col-span-4">
                                                <div className="grid grid-cols-2 h-full">
                                                    <div className="border-r border-black p-2">
                                                        <div className="font-bold">Invoice No :</div>
                                                        <div>{formData.invoiceNumber}</div>
                                                        <div className="font-bold mt-4">State Code</div>
                                                        <div>{formData.companyDetails.stateCode}</div>
                                                    </div>
                                                    <div className="p-2">
                                                        <div className="font-bold">Date :</div>
                                                        <div>{formData.date}</div>
                                                        <div className="mt-2">
                                                            <div className="text-xs">Vehicle: {formData.vehicleNumber}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Items Table */}
                                        <div className="border border-black mt-2">
                                            <div className="grid grid-cols-12 border-b border-black bg-gray-100 p-1 font-bold text-xs">
                                                <div className="col-span-1 border-r border-black text-center">S.No</div>
                                                <div className="col-span-5 border-r border-black text-center">Description of Service</div>
                                                <div className="col-span-2 border-r border-black text-center">HSN Code</div>
                                                <div className="col-span-1 border-r border-black text-center">Qty M.tons</div>
                                                <div className="col-span-1 border-r border-black text-center">Price per M.ton (INR)</div>
                                                <div className="col-span-2 text-center">Amount (INR)</div>
                                            </div>
                                            {calculations.items.map((item, index) => (
                                                <div key={index} className="grid grid-cols-12 border-b border-black p-1 text-xs">
                                                    <div className="col-span-1 border-r border-black text-center">{index + 1}</div>
                                                    <div className="col-span-5 border-r border-black px-1">{item.description}</div>
                                                    <div className="col-span-2 border-r border-black text-center">{item.sacCode}</div>
                                                    <div className="col-span-1 border-r border-black text-center">{item.qty}</div>
                                                    <div className="col-span-1 border-r border-black text-center">{item.rate}</div>
                                                    <div className="col-span-2 text-right px-1">{item.amount}</div>
                                                </div>
                                            ))}
                                        </div>

                                        {/* Tax Summary */}
                                        <div className="grid grid-cols-12 border border-black mt-2">
                                            <div className="col-span-8 border-r border-black p-2">
                                                <div className="font-bold">Our Bank Details:</div>
                                                <div>Name : {formData.bankDetails.bankName}</div>
                                                <div>A/c.No. {formData.bankDetails.accountNo}</div>
                                                <div>Bank Name: {formData.bankDetails.bankBranch}</div>
                                                <div>IFSC Code: {formData.bankDetails.ifscCode}</div>
                                            </div>
                                            <div className="col-span-4">
                                                <div className="space-y-1 text-xs p-2">
                                                    <div className="grid grid-cols-3 border-b pb-1">
                                                        <div className="col-span-2 font-bold">Total Amount before Tax</div>
                                                        <div className="text-right">{calculations.totalBeforeTax}</div>
                                                    </div>
                                                    <div className="grid grid-cols-3 border-b pb-1">
                                                        <div>Add : IGST @</div>
                                                        <div className="text-center">18%</div>
                                                        <div className="text-right">{calculations.igst}</div>
                                                    </div>
                                                    <div className="grid grid-cols-3 border-b pb-1">
                                                        <div className="col-span-2 font-bold">Total Amount after Tax:</div>
                                                        <div className="text-right">{calculations.totalAfterTax}</div>
                                                    </div>
                                                    <div className="grid grid-cols-3 border-t pt-1">
                                                        <div className="col-span-2 font-bold">Net Amount Payable</div>
                                                        <div className="text-right">{calculations.netAmount}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Amount in Words */}
                                        <div className="text-xs mt-2 p-2 border border-black">
                                            <div>Rupees : {calculations.amountInWords}</div>
                                        </div>

                                        {/* Declaration and Signature */}
                                        <div className="grid grid-cols-12 border border-black mt-4">
                                            <div className="col-span-8 border-r border-black p-2">
                                                <div className="font-bold">Subject to Hyderabad Jurisdiction Only</div>
                                                <div className="font-bold mt-2">Declaration:</div>
                                                <div>We declare that this invoice shows the actual price of the goods described and that all particulars are true and correct.</div>
                                            </div>
                                            <div className="col-span-4 p-2 text-center">
                                                <div className="font-bold mt-2">For {formData.companyDetails.companyName}</div>
                                                <div className="font-bold italic mt-8">Authorised Signatory</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 relative">
                    {/* Confirmation Dialog */}
                    {showConfirmDialog && (
                        <div className="fixed inset-0 modal-overlay flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
                                <div className="flex items-center space-x-3 mb-4">
                                    <div className="bg-amber-100 p-2 rounded-full">
                                        <svg className="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L4.316 16.5c-.77.833.192 2.5 1.732 2.5z" />
                                        </svg>
                                    </div>
                                    <h3 className="text-lg font-semibold text-gray-900">Unsaved Changes</h3>
                                </div>
                                <p className="text-gray-600 mb-6">
                                    You have unsaved changes. Would you like to save as draft before continuing?
                                </p>
                                <div className="flex space-x-3 justify-end">
                                    <button
                                        onClick={() => handleConfirmDialog(false)}
                                        className="btn-secondary px-4 py-2"
                                    >
                                        Discard Changes
                                    </button>
                                    <button
                                        onClick={async () => {
                                            await saveAsDraft();
                                            handleConfirmDialog(true);
                                        }}
                                        className="btn-draft px-4 py-2"
                                    >
                                        Save as Draft
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <div className="bg-white shadow-sm border-b border-gray-200 px-4 py-4 flex items-center justify-between sticky top-0 z-40">
                        <div className="flex items-center space-x-4">
                            <button
                                onClick={() => setSidebarOpen(true)}
                                className="p-2 rounded-lg hover:bg-gray-100 transition-colors"
                            >
                                <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                            </button>
                            <div>
                                <div className="flex items-center space-x-2">
                                    <h1 className="text-xl font-semibold text-gray-900">Invoice Manager</h1>
                                    {hasUnsavedChanges && <div className="unsaved-indicator" title="Unsaved changes"></div>}
                                </div>
                                <p className="text-sm text-gray-500">Create and manage invoices</p>
                            </div>
                        </div>
                        <div className="flex items-center space-x-3">
                            {formData.invoiceNumber && (
                                <button
                                    onClick={saveAsDraft}
                                    disabled={saving}
                                    className="btn-draft px-4 py-2 text-sm flex items-center space-x-2"
                                >
                                    {saving ? (
                                        <>
                                            <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-white" fill="none" viewBox="0 0 24 24">
                                                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                            <span>Saving...</span>
                                        </>
                                    ) : (
                                        <span>Save as Draft</span>
                                    )}
                                </button>
                            )}
                            <button
                                onClick={createNewInvoice}
                                className="btn-primary px-4 py-2 text-sm"
                            >
                                New Invoice
                            </button>
                        </div>
                    </div>

                    {/* Sidebar */}
                    {sidebarOpen && (
                        <div className="fixed inset-0 z-50 flex">
                            <div
                                className="flex-1 overlay"
                                onClick={() => setSidebarOpen(false)}
                            />
                            <div className={`sidebar w-80 h-full fixed left-0 top-0 z-50 overflow-y-auto ${sidebarOpen ? 'open' : ''}`}>
                                <div className="p-4 border-b border-gray-200">
                                    <div className="flex items-center justify-between mb-4">
                                        <h2 className="text-lg font-semibold text-gray-900">All Invoices</h2>
                                        <button
                                            onClick={() => setSidebarOpen(false)}
                                            className="p-2 rounded-lg hover:bg-gray-100"
                                        >
                                            <svg className="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                            </svg>
                                        </button>
                                    </div>

                                    {/* Search Filter */}
                                    <div className="filter-section">
                                        <label className="block text-xs font-medium text-gray-700 mb-2">Search</label>
                                        <input
                                            type="text"
                                            placeholder="Search invoices or customers..."
                                            value={searchQuery}
                                            onChange={(e) => setSearchQuery(e.target.value)}
                                            className="input-modern text-sm py-3"
                                        />
                                    </div>

                                    {/* Status Filter */}
                                    <div className="filter-section">
                                        <label className="block text-xs font-medium text-gray-700 mb-2">Status</label>
                                        <select
                                            value={statusFilter}
                                            onChange={(e) => setStatusFilter(e.target.value)}
                                            className="input-modern text-sm py-3"
                                        >
                                            <option value="all">All Status</option>
                                            <option value="draft">Draft</option>
                                            <option value="sent">Sent</option>
                                            <option value="paid">Paid</option>
                                            <option value="cancelled">Cancelled</option>
                                        </select>
                                    </div>

                                    {/* Date Filter */}
                                    <div className="filter-section">
                                        <label className="flex items-center text-xs font-medium text-gray-700 mb-2">
                                            <svg className="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                            </svg>
                                            Date Range
                                        </label>
                                        <div className="space-y-2">
                                            <input
                                                type="date"
                                                placeholder="From Date"
                                                value={dateFilter.from}
                                                onChange={(e) => setDateFilter(prev => ({ ...prev, from: e.target.value }))}
                                                className="input-modern text-sm py-2"
                                            />
                                            <input
                                                type="date"
                                                placeholder="To Date"
                                                value={dateFilter.to}
                                                onChange={(e) => setDateFilter(prev => ({ ...prev, to: e.target.value }))}
                                                className="input-modern text-sm py-2"
                                            />
                                        </div>
                                    </div>

                                    {/* Amount Filter */}
                                    <div className="filter-section">
                                        <label className="block text-xs font-medium text-gray-700 mb-2">Amount Range</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            <input
                                                type="number"
                                                placeholder="Min Amount"
                                                value={amountFilter.min}
                                                onChange={(e) => setAmountFilter(prev => ({ ...prev, min: e.target.value }))}
                                                className="input-modern text-sm py-2"
                                            />
                                            <input
                                                type="number"
                                                placeholder="Max Amount"
                                                value={amountFilter.max}
                                                onChange={(e) => setAmountFilter(prev => ({ ...prev, max: e.target.value }))}
                                                className="input-modern text-sm py-2"
                                            />
                                        </div>
                                    </div>

                                    {/* Customer Filter */}
                                    <div className="filter-section">
                                        <label className="block text-xs font-medium text-gray-700 mb-2">Customer</label>
                                        <input
                                            type="text"
                                            placeholder="Filter by customer name..."
                                            value={customerFilter}
                                            onChange={(e) => setCustomerFilter(e.target.value)}
                                            className="input-modern text-sm py-2"
                                        />
                                    </div>

                                    {/* Clear Filters */}
                                    <button
                                        onClick={clearAllFilters}
                                        className="btn-secondary w-full text-sm py-2"
                                    >
                                        Clear All Filters
                                    </button>
                                </div>

                                {/* Invoice List */}
                                <div className="p-4">
                                    {loading ? (
                                        <div className="text-center text-gray-500 py-8">Loading...</div>
                                    ) : filteredInvoices.length === 0 ? (
                                        <div className="text-center text-gray-500 py-8">No invoices found</div>
                                    ) : (
                                        filteredInvoices.map((invoice, index) => (
                                            <div
                                                key={invoice._id || index}
                                                onClick={() => selectInvoice(invoice)}
                                                className={`invoice-item ${selectedInvoice?._id === invoice._id ? 'active' : ''}`}
                                            >
                                                <div className="flex items-start justify-between mb-2">
                                                    <div className="flex-1">
                                                        <h3 className="font-semibold text-gray-900 text-sm">
                                                            {invoice.invoiceNumber || invoice.invoiceNo || `Invoice #${index + 1}`}
                                                        </h3>
                                                        <p className="text-xs text-gray-600 mt-1">
                                                            {invoice.customerDetails?.receiverName || 'No customer'}
                                                        </p>
                                                    </div>
                                                    <span className={`status-badge status-${invoice.status}`}>
                                                        {invoice.status}
                                                    </span>
                                                </div>
                                                <div className="flex items-center justify-between text-xs text-gray-500">
                                                    <span>{formatDate(invoice.createdAt)}</span>
                                                    <span className="font-semibold text-gray-700">
                                                        {formatCurrency(invoice.taxCalculation?.totalAfterTax || 0)}
                                                    </span>
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Main Content */}
                    <div className="max-w-2xl mx-auto p-4 pb-24">
                        {/* Invoice Header */}
                        <div className="section-card mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-lg font-semibold text-gray-900">Invoice Details</h2>
                                <div className="flex items-center space-x-2">
                                    {selectedInvoice && (
                                        <span className={`status-badge status-${selectedInvoice.status}`}>
                                            {selectedInvoice.status}
                                        </span>
                                    )}
                                    {isSaved && (
                                        <span className="text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full">
                                            Saved
                                        </span>
                                    )}
                                </div>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Invoice Number</label>
                                    <input
                                        type="text"
                                        name="invoiceNumber"
                                        placeholder="SSLE-001"
                                        value={formData.invoiceNumber}
                                        onChange={handleInputChange}
                                        className="input-modern"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Date</label>
                                    <input
                                        type="text"
                                        name="date"
                                        placeholder="DD-MM-YYYY"
                                        value={formData.date}
                                        onChange={handleInputChange}
                                        className="input-modern"
                                    />
                                </div>
                            </div>
                            <div className="mt-4">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Vehicle Number</label>
                                <input
                                    type="text"
                                    name="vehicleNumber"
                                    placeholder="Vehicle Number"
                                    value={formData.vehicleNumber}
                                    onChange={handleInputChange}
                                    className="input-modern"
                                />
                            </div>
                        </div>

                        {/* Company Details */}
                        <div className="section-card mb-6">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">Company Details</h3>
                            <div className="space-y-4">
                                <input
                                    type="text"
                                    name="companyName"
                                    placeholder="Company Name"
                                    value={formData.companyDetails.companyName}
                                    onChange={(e) => handleInputChange(e, 'companyDetails')}
                                    className="input-modern"
                                />
                                <textarea
                                    name="address"
                                    placeholder="Full Address"
                                    value={formData.companyDetails.address}
                                    onChange={(e) => handleInputChange(e, 'companyDetails')}
                                    rows="3"
                                    className="input-modern"
                                />
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <input
                                        type="tel"
                                        name="mobile"
                                        placeholder="Mobile Number"
                                        value={formData.companyDetails.mobile}
                                        onChange={(e) => handleInputChange(e, 'companyDetails')}
                                        className="input-modern"
                                    />
                                    <input
                                        type="email"
                                        name="email"
                                        placeholder="Email Address"
                                        value={formData.companyDetails.email}
                                        onChange={(e) => handleInputChange(e, 'companyDetails')}
                                        className="input-modern"
                                    />
                                </div>
                            </div>
                        </div>

                        {/* Customer Details */}

                        <div className="section-card mb-6">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">Customer Details (Billed To)</h3>
                            <div className="space-y-4">
                                <input
                                    type="text"
                                    name="receiverName"
                                    placeholder="Customer Company Name"
                                    value={formData.customerDetails.receiverName}
                                    onChange={(e) => handleInputChange(e, 'customerDetails')}
                                    className="input-modern"
                                />
                                <input
                                    type="text"
                                    name="receiverAddress"
                                    placeholder="Billing Address"
                                    value={formData.customerDetails.receiverAddress}
                                    onChange={(e) => handleInputChange(e, 'customerDetails')}
                                    className="input-modern"
                                />
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <input
                                        type="text"
                                        name="receiverCity"
                                        placeholder="City & Postal Code"
                                        value={formData.customerDetails.receiverCity}
                                        onChange={(e) => handleInputChange(e, 'customerDetails')}
                                        className="input-modern"
                                    />
                                    <input
                                        type="text"
                                        name="receiverState"
                                        placeholder="State"
                                        value={formData.customerDetails.receiverState}
                                        onChange={(e) => handleInputChange(e, 'customerDetails')}
                                        className="input-modern"
                                    />
                                </div>
                                {/* This GST field was missing */}
                                <input
                                    type="text"
                                    name="customerGST"
                                    placeholder="Customer GST Number"
                                    value={formData.customerDetails.customerGST}
                                    onChange={(e) => handleInputChange(e, 'customerDetails')}
                                    className="input-modern"
                                />
                            </div>
                        </div>

                        <div className="section-card mb-6">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">Shipping Details (Ship To)</h3>
                            <div className="space-y-4">
                                <input
                                    type="text"
                                    name="shipToName"
                                    placeholder="Ship To Company Name"
                                    value={formData.shippingDetails.shipToName}
                                    onChange={(e) => handleInputChange(e, 'shippingDetails')}
                                    className="input-modern"
                                />
                                <input
                                    type="text"
                                    name="shipToAddress"
                                    placeholder="Ship To Address"
                                    value={formData.shippingDetails.shipToAddress}
                                    onChange={(e) => handleInputChange(e, 'shippingDetails')}
                                    className="input-modern"
                                />
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <input
                                        type="text"
                                        name="shipToCity"
                                        placeholder="Ship To City"
                                        value={formData.shippingDetails.shipToCity}
                                        onChange={(e) => handleInputChange(e, 'shippingDetails')}
                                        className="input-modern"
                                    />
                                    <input
                                        type="text"
                                        name="shipToState"
                                        placeholder="Ship To State"
                                        value={formData.shippingDetails.shipToState}
                                        onChange={(e) => handleInputChange(e, 'shippingDetails')}
                                        className="input-modern"
                                    />
                                </div>
                                <input
                                    type="text"
                                    name="shipToGST"
                                    placeholder="Ship To GST Number"
                                    value={formData.shippingDetails.shipToGST}
                                    onChange={(e) => handleInputChange(e, 'shippingDetails')}
                                    className="input-modern"
                                />
                            </div>
                        </div>

                        {/* Bank Details */}
                        <div className="section-card mb-6">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">Bank Details</h3>
                            <div className="space-y-4">
                                <input
                                    type="text"
                                    name="bankName"
                                    placeholder="Account Holder Name"
                                    value={formData.bankDetails.bankName}
                                    onChange={(e) => handleInputChange(e, 'bankDetails')}
                                    className="input-modern"
                                />
                                <input
                                    type="text"
                                    name="accountNo"
                                    placeholder="Account Number"
                                    value={formData.bankDetails.accountNo}
                                    onChange={(e) => handleInputChange(e, 'bankDetails')}
                                    className="input-modern"
                                />
                                <input
                                    type="text"
                                    name="bankBranch"
                                    placeholder="Bank Name & Branch"
                                    value={formData.bankDetails.bankBranch}
                                    onChange={(e) => handleInputChange(e, 'bankDetails')}
                                    className="input-modern"
                                />
                                <input
                                    type="text"
                                    name="ifscCode"
                                    placeholder="IFSC Code"
                                    value={formData.bankDetails.ifscCode}
                                    onChange={(e) => handleInputChange(e, 'bankDetails')}
                                    className="input-modern"
                                />
                            </div>
                        </div>

                        {/* Items Section */}
                        <div className="section-card mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <h3 className="text-lg font-semibold text-gray-900">Service Items</h3>
                                <button
                                    onClick={addItem}
                                    className="btn-secondary px-4 py-2 text-sm"
                                >
                                    Add Item
                                </button>
                            </div>

                            {formData.items.length === 0 ? (
                                <div className="text-center py-12 text-gray-500">
                                    <div className="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                                        <svg className="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                                        </svg>
                                    </div>
                                    <p className="text-sm">No items added yet</p>
                                    <p className="text-xs text-gray-400 mt-1">Click "Add Item" to get started</p>
                                </div>
                            ) : (
                                formData.items.map((item, index) => (
                                    <div key={index} className="bg-gray-50 rounded-12 p-4 mb-4 border border-gray-200">
                                        <div className="flex items-center justify-between mb-3">
                                            <h4 className="font-medium text-gray-900">Item {index + 1}</h4>
                                            <button
                                                onClick={() => removeItem(index)}
                                                className="text-red-500 hover:text-red-700 p-1 rounded"
                                            >
                                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                                </svg>
                                            </button>
                                        </div>

                                        <div className="space-y-3">
                                            <input
                                                type="text"
                                                placeholder="Service Description"
                                                value={item.description}
                                                onChange={(e) => handleInputChange(e, 'items', index, 'description')}
                                                className="input-modern"
                                            />
                                            <input
                                                type="text"
                                                placeholder="HSN/SAC Code"
                                                value={item.sacCode}
                                                onChange={(e) => handleInputChange(e, 'items', index, 'sacCode')}
                                                className="input-modern"
                                            />
                                            <div className="grid grid-cols-2 gap-3">
                                                <input
                                                    type="number"
                                                    step="0.001"
                                                    placeholder="Quantity"
                                                    value={item.qty}
                                                    onChange={(e) => handleInputChange(e, 'items', index, 'qty')}
                                                    className="input-modern"
                                                />
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    placeholder="Rate ()"
                                                    value={item.rate}
                                                    onChange={(e) => handleInputChange(e, 'items', index, 'rate')}
                                                    className="input-modern"
                                                />
                                            </div>
                                            <div className="bg-white rounded-8 p-3 border border-gray-200">
                                                <div className="flex justify-between items-center">
                                                    <span className="text-sm font-medium text-gray-600">Amount:</span>
                                                    <span className="text-lg font-semibold text-green-600">
                                                        {calculations.items[index]?.amount || '0.00'}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>

                        {/* Invoice Summary */}
                        {formData.items.length > 0 && (
                            <div className="section-card mb-6">
                                <h3 className="text-lg font-semibold text-gray-900 mb-4">Invoice Summary</h3>
                                <div className="space-y-3">
                                    <div className="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span className="text-gray-600">Subtotal (Before Tax)</span>
                                        <span className="font-semibold text-gray-900">{calculations.totalBeforeTax}</span>
                                    </div>
                                    <div className="flex justify-between items-center py-2 border-b border-gray-200">
                                        <span className="text-gray-600">IGST @ 18%</span>
                                        <span className="font-semibold text-gray-900">{calculations.igst}</span>
                                    </div>
                                    <div className="flex justify-between items-center py-3 bg-blue-50 rounded-lg px-4">
                                        <span className="font-semibold text-blue-900">Total Amount</span>
                                        <span className="text-xl font-bold text-blue-900">{calculations.totalAfterTax}</span>
                                    </div>
                                    <div className="text-xs text-gray-600 mt-2 p-2 bg-gray-50 rounded-lg">
                                        <span className="font-medium">Amount in Words: </span>
                                        {calculations.amountInWords}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* Fixed Bottom Actions */}
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200">
                        <div className="max-w-2xl mx-auto">
                            <button
                                onClick={generatePDF}
                                disabled={pdfGenerating || !formData._id || !isSaved}
                                className={`btn-primary w-full py-4 text-lg font-semibold flex items-center justify-center space-x-3 ${(pdfGenerating || !formData._id || !isSaved) ? 'opacity-50 cursor-not-allowed' : ''
                                    }`}
                            >
                                {pdfGenerating ? (
                                    <>
                                        <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        <span>Generating PDF...</span>
                                    </>
                                ) : !formData._id || !isSaved ? (
                                    <span>Save as Draft to Download PDF</span>
                                ) : (
                                    <span>Download PDF Invoice</span>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<InvoiceManagementSystem />, document.getElementById('root'));
    </script>
</body>

</html>